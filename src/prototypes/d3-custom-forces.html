<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node circle {
  stroke: black	;
  stroke-width: 0px;
}
.edge path{
    fill: none;
    stroke: #666;
    stroke-width: 1.5px;
}

svg {  }
</style>
<svg width="900" height="900"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/qwest/4.4.5/qwest.min.js"></script>
<script>
//create somewhere to put the force directed graph

const svg = d3.select("svg"),
    width  = + svg.attr("width"),
    height = + svg.attr("height");

const radius = 10,
    center = { "x": width / 2, "y": height / 2 },
    axis = Math.min(width, height) * 0.45;

const radiusOmega = 5;

const graph = {
    nodes : [
        {   "id"  : "u", "name": "u",      "val" : 10, "color": "#D2691E", "graph": "A", "type": "+x"},
        {   "id"  : "n", "name": "n",      "val" : 10, "color": "#D2691E", "graph": "A", "type": "-x"},
        {   "id"  : "t", "name": "t",      "val" : 10, "color": "#808080", "graph": "B", "type": "-x"},
        {   "id"  : "a", "name": "a",      "val" : 10, "color": "#808080", "graph": "B", "type": "0"},
        {   "id"  : "h", "name": "h",      "val" : 10, "color": "#444444", "graph": "B", "type": "+x"},
        {   "id"  : "R", "name": "R",      "val" : 10, "color": "#ff0000", "graph": "C", "type": "-y" },
        {   "id"  : "L", "name": "L",      "val" : 10, "color": "#7B68EE", "graph": "C", "type": "+y"},
        {   "id"  : "S", "name": "\u03A3", "val" : 10, "color": "#006400", "graph": "D", "type": "-x"},
        {   "id"  : "P", "name": "\u03C0", "val" : 10, "color": "#0000CD", "graph": "D", "type": "+x"}
    ],
    links : [
        {  "id": 1, "source": "u", "target": "n", "name": "",           "type": "link", "length": 100 },
        {  "id": 2, "source": "t", "target": "a", "name": "Ependymal", "type": "link", "length": 40 , "lyph": 2 },
        {  "id": 3, "source": "a", "target": "h", "name": "Ependymal", "type": "link", "length": 40 , "lyph": 2 },
        {  "id": 4, "source": "R", "target": "L", "name": "Pulmonary", "type": "path", "length": 70 , "lyph": 3, "base": "y"},
        {  "id": 5, "source": "L", "target": "R", "name": "Systemic",  "type": "path", "length": 70 , "lyph": 4, "base": "y"},
        {  "id": 6, "source": "S", "target": "P", "name": "Gut",       "type": "path", "length": 90 , "lyph": 5 },
        {  "id": 7, "source": "P", "target": "S", "name": "Gut'",      "type": "path", "length": 90 , "lyph": 1 }
    ]
};

const omega_trees = {
    nodes: [
        //omega trees
        {   "id"  : "RL_1", "name": "RL_1", "val" : 5, "color": "#ff0000", "graph": "Omega 1", "type": "0", "parent": 4, "position": 1},
        {   "id"  : "RL_2", "name": "RL_2", "val" : 5, "color": "#ff0000", "graph": "Omega 2", "type": "0", "parent": 4, "position": 2},
        {   "id"  : "RL_3", "name": "RL_3", "val" : 5, "color": "#ff0000", "graph": "Omega 3", "type": "0", "parent": 4, "position": 3},
        {   "id"  : "RL_4", "name": "RL_4", "val" : 5, "color": "#ff0000", "graph": "Omega 4", "type": "0", "parent": 4, "position": 4},
        {   "id"  : "RL_5", "name": "RL_5", "val" : 5, "color": "#ff0000", "graph": "Omega 5", "type": "0", "parent": 4, "position": 5},

        {   "id"  : "LR_1", "name": "LR_1", "val" : 5, "color": "#ff0000", "graph": "Omega 6", "type": "0", "parent": 5, "position": 1},
        {   "id"  : "LR_2", "name": "LR_2", "val" : 5, "color": "#ff0000", "graph": "Omega 7", "type": "0", "parent": 5, "position": 2},
        {   "id"  : "LR_3", "name": "LR_3", "val" : 5, "color": "#ff0000", "graph": "Omega 8", "type": "0", "parent": 5, "position": 3},
        {   "id"  : "LR_4", "name": "LR_4", "val" : 5, "color": "#ff0000", "graph": "Omega 9", "type": "0", "parent": 5, "position": 4},
        {   "id"  : "LR_5", "name": "LR_5", "val" : 5, "color": "#ff0000", "graph": "Omega 10", "type": "0", "parent": 5, "position": 5},

    ]
};

var omegaNode = svg.append("g").attr("class", "node").selectAll("circle")
    .data(omega_trees.nodes).enter()
    .append("circle")
    .attr("r", radiusOmega)
    .attr("fill", function(x){return x.color});

//set up the simulation
var simulation = d3.forceSimulation().nodes(graph.nodes);

simulation
    .force("link", d3.forceLink(graph.links).id(function(d) { return d.id }))
    .force("link", d3.forceLink(graph.links)
        .distance(function(d) {
            return 0.01 * d.length * (2 * axis)}).strength(1))
    //.force("collide",d3.forceCollide( function(d){return d.r}).iterations(16))
    //.force("charge", d3.forceManyBody())
    .force("center", d3.forceCenter(center.x, center.y))
    .force("y", d3.forceY(0).y(d => (d.type === "-y")? -axis
        : (d.type === "+y")? axis : 0))
    .force("x", d3.forceX().x(d => (d.type === "-x")? -axis
            : (d.type === "+x")? axis : 0))
;

simulation.on("tick", tick );

var path = svg.append("g").attr("class", "edge").selectAll("path")
    .data(graph.links)
    .enter().append("path")
    .attr("id", function(d,i) { return "path_" + i; }) //a unique ID to reference later
    .attr("class", "path");

var pathLabel = svg.append("g").selectAll("path")
    .data(graph.links).enter().append("text")
    .attr("class", "pathLabel")
    .style("text-anchor","middle")
    .append("textPath")
    .attr("xlink:href",function(d,i){return "#path_" + i;}) //path ID
    .attr("startOffset", "50%")
    .text(function(d) { return d.name; }); //place the text halfway on the arc

var lyphIcon = svg.append("g").selectAll("path")
    .data(graph.links.filter(link => link.lyph)).enter().append("rect")
    .attr("class", "lyphIcon")
    .attr("xlink:href", function(d,i){return "#path_" + i;}) //icon ID
    .attr("width", 50)
    .attr("height", 30)
    .attr("fill", function(d){ return "#"+((1<<24)*Math.random()|0).toString(16)});

var node = svg.append("g").attr("class", "node").selectAll("circle")
    .data(graph.nodes).enter()
    .append("circle")
    .attr("r", radius)
    .attr("fill", function(x){return x.color});

var nodeLabel = svg.append("g").selectAll("node").data(graph.nodes)
    .enter().append("text")
    .attr("class", "nodeLabel")
    .attr("x", 1.2 * radius)
    .attr("y", 1.2 * radius)
    .text(function(d) { return d.name; });

var drag_handler = d3.drag()
    .on("start", drag_start)
    .on("drag", drag_drag)
    .on("end", drag_end);

drag_handler(node);

//drag handler
function drag_start(d) {
    if (!d3.event.active) { simulation.alphaTarget(0.8).restart(); }
    d.fx = d.x;
    d.fy = d.y;
}
function drag_drag(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
}
function drag_end(d) {
    if (!d3.event.active) { simulation.alphaTarget(0); }
    d.fx = null;
    d.fy = null;
}

function drawEdge(d) {
    if (d.type === "path"){
        var dx = d.target.x - d.source.x,
            dy = d.target.y - d.source.y,
            dr = Math.sqrt(dx * dx + dy * dy) / 4;
        return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
    } else {
        if (d.type === "link"){
            return "M" + d.source.x + "," + d.source.y + " L " + d.target.x + "," + d.target.y;
        }
    }
}

function transform(d) {
    return "translate(" + d.x + "," + d.y + ")";
}

function translateAlongPath(d) {
    if (d.type === "path") {
        var v = {x: d.target.x - d.source.x, y: d.target.y - d.source.y};
        var v2 = {x: v.x/2, y: v.y/2};
        var v3 = {x: center.x + v2.y, y: center.y + v2.x};
        return "translate(" + v3.x + "," + v3.y + ")";
    } else {
        if (d.type === "link") {
            return "translate(" + ((d.target.x + d.source.x) / 2) + "," + ((d.target.y + d.source.y)) / 2 + ")";
        }
    }
}

function tick(e) {
    node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });

    nodeLabel.attr("transform", transform);
    path.attr("d", drawEdge);
    lyphIcon.attr("transform", translateAlongPath);

}
</script>